# 未確定仕様の決定事項一覧 v1.0

**作成日**: 2026-02-02  
**ステータス**: 決定待ち

---

## 概要

以下の5つの未確定事項について、複数のオプションと各トレードオフを提示します。  
各項目ごとに最小2〜3の選択肢を示し、実装への影響を明示しています。

---

## 1. 日付フィルタの詳細仕様

### 背景
Dashboard上で日付フィルタを提供する際、以下の詳細が未決定：
- タイムゾーン処理
- 日付の境界包含ルール
- 入力形式の許容度

### 影響範囲
- **バックエンド**: フィルタ適用ロジック（`backend/app/services/filter_view_service.py`）
- **フロントエンド**: カレンダーUI（`frontend/src/components/dashboard/FilterBar.tsx`）
- **データモデル**: Dataset スキーマ検証
- **テスト**: フィルタテストケース数

---

### オプション A: **JST固定・開始終了含む・ISO 8601のみ** ⭐⭐⭐⭐⭐

**仕様**
- タイムゾーン: JST（UTC+9）に固定
- 日付範囲: 開始日と終了日の両端を**包含** （2024-01-01 ～ 2024-01-31 = 31日間）
- 入力形式: ISO 8601（YYYY-MM-DD）のみ許可、文字列の緩い解析は不可
- 内部: Unix timestamp（ミリ秒）で統一管理

**長所**
- タイムゾーン処理が不要で実装最小限
- ユーザが直感的に理解しやすい（月末を含むなど）
- フロントエンド実装が単純化（ISO 8601パーサのみ）
- テストケースが限定的

**短所**
- 海外ユーザがいる場合は対応困難（V2以降でユーザタイムゾーン対応が必須）

**推奨度**: ⭐⭐⭐⭐⭐  
理由: 社内BIで日本メイン、MVP段階ではシンプルさが優先。将来のユーザタイムゾーン対応もスコープ分離できる。

---

### オプション B: **ユーザタイムゾーン・開始含む終了未含・複数形式対応** ⭐⭐⭐

**仕様**
- タイムゾーン: ユーザプロフィールで設定可能（デフォルト JST）
- 日付範囲: 開始日は**含む**、終了日は**未含む** （2024-01-01 00:00:00 ～ 2024-02-01 00:00:00 未満）
- 入力形式: ISO 8601 + "2024年1月1日" など日本語形式 + 相対表現（"今月"など）を自然言語解析で対応
- 内部: DatetimeとTimezoneのペアで管理

**長所**
- グローバル対応可能（将来の事業拡張に強い）
- 開始・終了未含は SQL標準（PostgreSQL等では一般的）
- ユーザが複数形式で入力可能（UX向上）

**短所**
- タイムゾーン変換の計算量増加（クエリパフォーマンス低下の可能性）
- 自然言語解析ライブラリ導入コスト
- テストケース数が大幅増加（組み合わせ爆発）
- バックエンド・フロントエンド双方の実装工数増加

**推奨度**: ⭐⭐⭐  
理由: 将来性はあるが MVP段階では過度な機能。V1.5以降で実装推奨。

---

### オプション C: **JST固定・開始含む終了未含・ISO 8601+ Unix timestamp** ⭐⭐

**仕様**
- タイムゾーン: JST固定
- 日付範囲: 開始含む・終了未含（業界標準）
- 入力形式: ISO 8601 + Unix timestamp（数値）
- 内部: Unix timestamp で統一

**長所**
- 実装難度が低~中
- Unix timestamp は API/バックエンド統合に有利
- SQL操作が標準化

**短所**
- 開始・終了未含はユーザにとって直感的でない（2024-01-01 ～ 2024-01-31 と指定したら 1月31日が除外される）
- エンドユーザからの混乱・バグ報告リスク

**推奨度**: ⭐⭐  
理由: 技術的には実現可能だが、UX上の欠点が大きい。

---

## 2. 許可ライブラリのホワイトリスト

### 背景
Pythonカード実行時に、どのライブラリを許可するかが未決定。  
`executor/app/sandbox.py` の `BLOCKED_MODULES` ホワイトリスト、および Docker イメージに含めるパッケージを決定必要。

### 影響範囲
- **Executor基盤**: `executor/Dockerfile`、`executor/requirements.txt`
- **実行セキュリティ**: `executor/app/sandbox.py` のインポートフック
- **カード開発体験**: ユーザが使用可能な分析ライブラリの種類
- **イメージサイズ**: 500MB ～ 1.5GB レベルで変動

---

### オプション A: **最小構成（pandas/pyarrow/plotly のみ）** ⭐⭐⭐⭐⭐

**ライブラリリスト**
```
pandas==2.2.0
pyarrow==15.0.0
plotly==5.18.0
python-dateutil==2.8.2
```

**長所**
- Executor イメージサイズ最小（~600 MB）
- セキュリティ表面積が最小
- 統計分析・可視化の基本は十分対応可能
- 新しいライブラリ追加時の審査プロセスが明確

**短所**
- ユーザがより複雑な分析（e.g., scikit-learn 機械学習）に対応不可
- "このライブラリが使いたい" 要望への対応がケースバイケース
- ユーザ満足度が限定的

**推奨度**: ⭐⭐⭐⭐⭐  
理由: 社内 BI MVP のスコープでは十分。セキュリティ・保守性が高い。

---

### オプション B: **標準構成（A + numpy/scipy/matplotlib）** ⭐⭐⭐⭐

**ライブラリリスト**
```
pandas==2.2.0
pyarrow==15.0.0
plotly==5.18.0
numpy==1.26.3
scipy==1.11.4
matplotlib==3.8.2
python-dateutil==2.8.2
```

**長所**
- 数値計算・統計分析が充実（numpy/scipy）
- matplotlib で Plotly 以外の可視化も可能
- 大半の分析ユースケースに対応

**短所**
- イメージサイズ増加（~1.0 GB）
- 依存関係が複雑化（セキュリティアップデート時の検証工数増加）
- scipy のコンパイル依存性 → イメージビルド時間増加

**推奨度**: ⭐⭐⭐⭐  
理由: バランスが取れた選択。V1 段階での導入が妥当。

---

### オプション C: **拡張構成（B + scikit-learn/xgboost/statsmodels など）** ⭐⭐

**ライブラリリスト**
```
# B のリスト +
scikit-learn==1.3.2
xgboost==2.0.3
statsmodels==0.14.0
seaborn==0.13.1
```

**長所**
- 機械学習・予測分析が可能
- ユーザの要望への対応度が最大
- 社内 BI として差別化ポイント

**短所**
- イメージサイズ大幅増加（~1.5 GB）
- セキュリティ審査対象ライブラリ大幅増加
- ビルド・デプロイ時間増加
- 未知の攻撃ベクトル増加リスク

**推奨度**: ⭐⭐  
理由: MVP では過度。V2+ のロードマップに記載。

---

## 3. S3 認証方式

### 背景
S3 CSV 取り込み機能において、S3 アクセス方式が未決定：
- `backend/app/db/s3.py` でのクライアント認証処理
- AWS 認証情報の管理方法
- ユーザがファイルを選択する UI フロー

### 影響範囲
- **バックエンド**: S3 クライアント初期化ロジック
- **IAM**: AWS IAM 権限設定
- **UI**: S3 ファイル選択画面（S3 バケット制限、マルチテナント考慮など）
- **運用**: 認証情報ローテーション手順

---

### オプション A: **IAM ロール（ECS タスク・静的クレデンシャル）** ⭐⭐⭐⭐⭐

**方式**
- API/Executor ECS タスクに IAM ロールをアタッチ
- STS Assume Role で一時クレデンシャル取得
- ユーザは S3 バケット/パスを指定するのみ → API が代わりにアクセス
- バケット側の IAM ポリシー: `s3:GetObject` 最小限

**長所**
- AWS ネイティブ・セキュアな設計
- 静的な IAM キー管理不要
- ロール単位で権限制御可能（各 ECS タスク異なるロール設定可）
- 監査ログ（CloudTrail）統合が自動
- ユーザ側で AWS 認証情報を登録・管理する手間なし

**短所**
- S3 アクセス権限が API 全体に集中（ユーザA が ユーザB のバケットにアクセス可能な設計になりやすい）
- マルチテナント化時、テナント間の S3 バケット分離が別途設計必要

**推奨度**: ⭐⭐⭐⭐⭐  
理由: MVP の社内 BI では十分。セキュリティと保守性が優れている。

---

### オプション B: **ユーザ別 AWS アクセスキー登録** ⭐⭐⭐

**方式**
- ユーザが個別に AWS アクセスキー（ID/Secret）を生成
- ユーザ設定画面で API に登録（暗号化して DynamoDB 保存）
- API は登録キーを使用して S3 にアクセス
- 各ユーザ単位で IAM ポリシー設定

**長所**
- テナント・ユーザ単位の権限分離が明確
- 将来のマルチテナント・SaaS 化に有利
- 外部の S3 バケット（他 AWS アカウント）にもアクセス可能
- ユーザ監査ログが細かい

**短所**
- ユーザが AWS 認証情報を管理する手間（混乱、セキュリティリスク）
- 认证情報保存・暗号化の実装工数増加
- キーローテーション手順が複雑
- 認証情報漏洩時のインシデント対応が増加

**推奨度**: ⭐⭐⭐  
理由: 将来の SaaS 化を見据えるなら選択価値あり。MVP では不要。

---

### オプション C: **Cognito + AssumeRoleWithWebIdentity** ⭐⭐

**方式**
- Cognito ユーザプール で ユーザ認証
- Cognito 認証後、AssumeRoleWithWebIdentity で一時クレデンシャル取得
- フロントエンドが一時クレデンシャルで S3 直接アクセス
- バックエンド経由不要

**長所**
- クライアント側で直接 S3 アクセス可能（API スルーパス化）
- 大容量ファイル転送時のレイテンシ削減

**短所**
- 社内 BI では Cognito 導入は過度
- ユーザ認証が複数方式に分散
- 実装・運用が複雑化

**推奨度**: ⭐⭐  
理由: MVP では不要。SaaS 化後の検討対象。

---

## 4. HTML カード実行時に許可する JS ライブラリ管理方式

### 背景
カード実行で生成される HTML を iframe で表示する際、許可する JS ライブラリ（Plotly等）の管理方式が未決定。

### 影響範囲
- **フロントエンド**: `frontend/src/components/dashboard/CardContainer.tsx` での CSP ヘッダ設定
- **バックエンド**: `backend/app/core/security.py` での許可リスト管理
- **S3**: 静的アセット配置（`s3://bi-static/js/`）
- **CI/CD**: ライブラリバージョン管理・更新フロー

---

### オプション A: **社内 CDN 配信（バージョン固定・パス明示）** ⭐⭐⭐⭐⭐

**実装方式**
- 許可ライブラリ（Plotly v2.27.0 等）を S3 / CloudFront でホスト
- `https://cdn.internal.company.com/plotly/2.27.0/plotly.min.js` のような固定パス
- CSP: `script-src 'unsafe-inline' https://cdn.internal.company.com`
- バージョン更新時 → S3 新パスにアップロード → CSP ホワイトリスト更新

**長所**
- バージョン管理が明確
- 全カード・全ユーザが同一ライブラリバージョン使用 → 互換性リスク低い
- CDN キャッシュで高速配信
- CSP 設定がシンプル

**短所**
- ライブラリ更新に手作業が発生（S3 アップロード、CSP ホワイトリスト修正）
- ユーザがカスタムバージョン使用不可

**推奨度**: ⭐⭐⭐⭐⭐  
理由: MVP の安全性・管理性が最優先。推奨。

---

### オプション B: **npm CDN（jsDelivr/cdnjs・バージョン自由）** ⭐⭐⭐

**実装方式**
- jsDelivr (`https://cdn.jsdelivr.net/npm/plotly.js@2.27.0/dist/plotly.min.js`) など公開 CDN 使用
- ホワイトリスト対象ドメイン: `https://cdn.jsdelivr.net`, `https://cdnjs.cloudflare.com`
- ユーザが CSS/HTML 内で任意バージョン指定可能
- CSP: `script-src 'unsafe-inline' https://cdn.jsdelivr.net`

**長所**
- ライブラリバージョン追加が簡単（ユーザ側で指定）
- インターネット接続環境ではサーバ管理コスト不要
- Plotly 新バージョンをユーザがすぐ利用可能

**短所**
- 外部 CDN 依存 → ダウンタイム・パフォーマンス影響
- ユーザが異なるバージョンを混在 → 検証・互換性リスク
- セキュリティ: 外部ドメイン CDN からの供給チェーン攻撃リスク

**推奨度**: ⭐⭐⭐  
理由: ユーザの自由度が高いが、MVP では検証コスト増加。V1 以降検討。

---

### オプション C: **バンドル配信（Webpack・ローカルアセット）** ⭐⭐

**実装方式**
- Plotly等を npm でインストール → Webpack でバンドル
- HTML 生成時に script タグを自動挿入
- `<script>/* Plotly コード内埋め込み */</script>`
- CSP: `script-src 'unsafe-inline'`

**長所**
- 外部 CDN 不要
- HTML 単体で完結（iframe srcDoc に全コンテンツ含まれる）

**短所**
- HTML ペイロード大幅増加（MB オーダー）
- キャッシュ効率悪化
- パフォーマンス低下

**推奨度**: ⭐⭐  
理由: パフォーマンス面で非推奨。

---

## 5. 相対日付フィルタ（過去 7 日など）

### 背景
ページフィルタで「過去 7 日」「今月」「去年」といった相対日付表現をサポートするかが未決定。  
`docs/requirements.md` 1.3 に「MVP 範囲外」と記載だが、実装優先度を確認必要。

### 影響範囲
- **フロントエンド**: `frontend/src/components/dashboard/FilterBar.tsx` のフィルタ UI
- **バックエンド**: `backend/app/services/filter_view_service.py` のフィルタ適用ロジック
- **テスト**: テストケース（時系列依存テスト）
- **UX**: ユーザが日付を手入力する手間

---

### オプション A: **MVP から外す（絶対日付範囲のみ）** ⭐⭐⭐⭐

**実装**
- フィルタバーでカレンダー UI のみ提供
- ユーザが開始日・終了日を明示的に選択
- 相対日付は将来の要望に応じて V1+ で実装

**長所**
- 実装工数最小
- テスト複雑度低い
- MVP デリバリーが早い

**短所**
- ユーザが毎日フィルタを更新する手間（定期レポートの場合）
- "過去 7 日は？" という要望が確実に上がる

**推奨度**: ⭐⭐⭐⭐  
理由: MVP スコープの縮小に。V1 で実装予定なら最初から除外推奨。

---

### オプション B: **MVP に含める（簡易版）** ⭐⭐⭐

**実装**
- フィルタバーに相対日付プリセット：「過去 7 日」「過去 30 日」「今月」「去年」
- バックエンド: 現在日時（JS の当日基準）から計算
- FilterView に相対日付を保存 → 復元時に再計算

**長所**
- ユーザ体験向上（定期レポートが楽）
- MVP + αで差別化ポイント

**短所**
- タイムゾーン処理が必須（決定項目 1 との連動）
- テスト複雑度増加（時系列テスト = flaky test の可能性）
- FilterView 保存時に相対/絶対の区別が必要

**推奨度**: ⭐⭐⭐  
理由: 時間があれば実装価値あり。決定項目 1（タイムゾーン）と共に判断推奨。

---

### オプション C: **高度な相対日付対応（自然言語処理）** ⭐

**実装**
- "今月" "去年の1月" "3 ヶ月前" などを自然言語で入力
- NLP ライブラリ（e.g., dateutil.parser の拡張）で解析
- 複雑な期間計算に対応

**長所**
- UX 最高

**短所**
- 実装難度・テスト難度が非常に高い
- 言語（日本語/英語）ごとの実装
- バグが多い可能性

**推奨度**: ⭐  
理由: MVP では不要。V2+ のストレッチゴール。

---

---

## 確定決定セット（2026-02-02 確定）

以下の組み合わせで確定しました：

| 項目 | 確定オプション | 決定理由 |
|------|---------------|----------|
| 1. 日付フィルタ仕様 | **Modified-A（Dataset基準・開始終了含む・ISO8601のみ）** | Dataset内日付をそのまま使用、タイムゾーン変換なし、直感的 |
| 2. ライブラリホワイトリスト | **B（標準構成）** | pandas + numpy/scipy/matplotlib、数値計算・統計分析に対応 |
| 3. S3認証方式 | **A（IAMロール）** | AWS ネイティブ・セキュア |
| 4. JS ライブラリ管理 | **A（社内CDN・バージョン固定）** | 管理・セキュリティが明確 |
| 5. 相対日付フィルタ | **A（MVP外す）** | デリバリー加速、V1で実装予定 |

**特記事項**
- 日付フィルタ：当初案から変更。タイムゾーン処理を行わず、Dataset内の日付データをそのまま使用する方式を採用。
- ライブラリ：最小構成から標準構成に変更。numpy/scipy/matplotlib を追加し、数値計算・統計分析を充実させる。
- 相対日付フィルタは「V1 の計画」として roadmap に記載

---

## 次のステップ

1. **意思決定者による確認**: 上記の推奨セットで OK か確認
2. **異なる選択肢の選定**: 推奨と異なる項目がある場合は理由と共に記載
3. **ドキュメント更新**: `docs/requirements.md` と `docs/design.md` を修正
4. **実装タスク化**: 各項目を「次の実装タスク」として詳細化

